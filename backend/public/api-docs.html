<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voluntree API Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #4CAF50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .status-item {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .status-server {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-db {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .api-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .section-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }
        
        .endpoint {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .method {
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
            color: white;
        }
        
        .method.get {
            background: #4CAF50;
        }
        
        .method.post {
            background: #2196F3;
        }
        
        .method.put {
            background: #FF9800;
        }
        
        .method.delete {
            background: #f44336;
        }
        
        .endpoint-path {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            color: #333;
            font-weight: 600;
        }
        
        .endpoint-desc {
            color: #666;
            margin-bottom: 15px;
        }
        
        .endpoint-body {
            margin-top: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-test {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn-test:hover {
            background: #45a049;
        }
        
        .btn-test:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .response {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            display: none;
        }
        
        .response.show {
            display: block;
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .status-code {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .status-code.success {
            background: #4CAF50;
            color: white;
        }
        
        .status-code.error {
            background: #f44336;
            color: white;
        }
        
        .response-body {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .test-all-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 20px;
            transition: background 0.3s;
        }
        
        .test-all-btn:hover {
            background: #5568d3;
        }
        
        /* Accordion styles (added) */
        .accordion { border-radius: 10px; overflow: hidden; margin-bottom: 18px; }
        .accordion-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            padding: 18px 22px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.06);
            margin-bottom: 8px;
            font-weight: 700;
            color: #333;
        }
        .accordion-toggle .title { display:flex; gap:12px; align-items:center; }
        .accordion-toggle .icon {
            transition: transform .25s ease;
            font-size: 18px;
            color: #666;
        }
        .accordion-toggle.collapsed .icon { transform: rotate(-90deg); } /* collapsed state rotates icon */
        .accordion-content {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.04);
            display: none; /* collapsed by default */
        }
        .accordion-content.show { display: block; }
        /* Slight spacing for inner endpoints */
        .accordion-content .api-section { margin: 0; box-shadow: none; border-left: none; }

        /* Sidebar styles (added) */
        .layout {
            display: flex;
            gap: 20px;
        }
        .sidebar {
            width: 220px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 6px 14px rgba(0,0,0,0.06);
            height: calc(100vh - 40px);
            position: sticky;
            top: 20px;
            align-self: flex-start;
        }
        .sidebar .brand { font-weight:700; margin-bottom:10px; color:#333; display:flex; gap:8px; align-items:center}
        .sidebar .nav { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
        .sidebar .nav button {
            text-align:left;
            background: transparent;
            border: none;
            padding: 10px 12px;
            border-radius:6px;
            cursor: pointer;
            font-weight:600;
            color:#333;
        }
        .sidebar .nav button:hover { background:#f1f5f9; }
        .sidebar .logout { color:#b91c1c; }
        /* simple toast */
        #toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            display: none;
            z-index: 9999;
            font-size: 13px;
        }

        /* Users sidebar (added) */
        .users-sidebar-toggle {
            display:inline-block;
            margin-left:12px;
            padding:8px 12px;
            background:#fff;
            border-radius:6px;
            color:#2f80ed;
            border:1px solid #dbeafe;
            cursor:pointer;
            font-weight:600;
            text-decoration:none;
        }
        .users-sidebar {
            position:fixed;
            left:0;
            top:0;
            bottom:0;
            width:340px;
            background:#ffffff;
            box-shadow: 2px 0 12px rgba(0,0,0,0.12);
            transform: translateX(-100%);
            transition: transform .28s ease;
            z-index:1000;
            overflow:auto;
            padding:18px;
        }
        .users-sidebar.open { transform: translateX(0); }
        .users-sidebar .header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
        .users-sidebar .header h3 { margin:0; font-size:1.1em; color:#222; }
        .users-sidebar .close-btn { background:#f3f4f6; border:0; padding:6px 8px; border-radius:6px; cursor:pointer; }
        .users-sidebar .users-table { width:100%; border-collapse:collapse; font-family:monospace; font-size:13px; }
        .users-sidebar .users-table th, .users-sidebar .users-table td { padding:8px 6px; border-bottom:1px solid #eee; text-align:left; }
        .users-sidebar .users-table th { background:#fafafa; font-weight:700; font-size:12px; color:#444; }
        .users-sidebar .small { font-size:12px; color:#666; margin-top:8px; }
        .users-sidebar .refresh-btn { background:#2f80ed;color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:600;margin-left:8px; }
        .users-sidebar .empty { padding:18px; color:#777; text-align:center; }
    </style>
</head>
<body>
    <div class="layout">
       
        <div style="flex:1">
            <div class="container">
                <!-- Authentication APIs (now inside accordion) -->
                <div class="accordion" id="accordion-authentication">
                    <div class="accordion-toggle collapsed" data-target="auth-content" role="button" aria-expanded="false" tabindex="0">
                        <div class="title"><span>üîê</span><span>Authentication</span></div>
                        <div class="icon">‚ñæ</div>
                    </div>
                    <div id="auth-content" class="accordion-content" aria-hidden="true">
                        <div class="api-section">
                            <h2 class="section-title">üîê Authentication</h2>
                            
                            <div class="endpoint">
                                <div class="endpoint-header">
                                    <span class="method post">POST</span>
                                    <span class="endpoint-path">/api/auth/register</span>
                                </div>
                                <div class="endpoint-desc">Register a new user</div>
                                <div class="endpoint-body">
                                    <div id="auth-register-form">
                                        <div class="input-group">
                                            <label>Name</label>
                                            <input id="reg-name" type="text" placeholder="John Doe" />
                                        </div>
                                        <div class="input-group">
                                            <label>Email</label>
                                            <input id="reg-email" type="email" placeholder="john@example.com" />
                                        </div>
                                        <div class="input-group">
                                            <label>Mobile</label>
                                            <input id="reg-mobile" type="text" placeholder="123-456-7890" />
                                        </div>
                                        <div class="input-group">
                                            <label>Password</label>
                                            <input id="reg-password" type="password" placeholder="password123" />
                                        </div>
                                        <div class="input-group">
                                            <label>Confirm Password</label>
                                            <input id="reg-confirmPassword" type="password" placeholder="password123" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('POST', '/api/auth/register', 'auth-register-form', 'auth-register-response')">Test Endpoint</button>
                                    <div class="response" id="auth-register-response"></div>
                                </div>
                            </div>
                            
                            <div class="endpoint">
                                <div class="endpoint-header">
                                    <span class="method post">POST</span>
                                    <span class="endpoint-path">/api/auth/login</span>
                                </div>
                                <div class="endpoint-desc">Login user - Returns JWT token on success</div>
                                <div class="endpoint-body">
                                    <div id="auth-login-form">
                                        <div class="input-group">
                                            <label>Email</label>
                                            <input id="login-email" type="email" placeholder="john@example.com" />
                                        </div>
                                        <div class="input-group">
                                            <label>Password</label>
                                            <input id="login-password" type="password" placeholder="password123" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('POST', '/api/auth/login', 'auth-login-form', 'auth-login-response')">Test Endpoint</button>
                                    <div class="response" id="auth-login-response"></div>
                                    <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; font-size: 0.9em;">
                                        <strong>Success Response:</strong> Returns token and user data. Status: 200
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Forgot Password API (accordion) -->
                <div class="accordion" id="accordion-forgot">
                    <div class="accordion-toggle collapsed" data-target="forgot-content" role="button" aria-expanded="false" tabindex="0">
                        <div class="title"><span>üîë</span><span>Password Reset</span></div>
                        <div class="icon">‚ñæ</div>
                    </div>
                    <div id="forgot-content" class="accordion-content" aria-hidden="true">
                        <div class="api-section">
                            <h2 class="section-title">üîë Password Reset</h2>
                            
                            <div class="endpoint">
                                <div class="endpoint-header">
                                    <span class="method post">POST</span>
                                    <span class="endpoint-path">/api/auth/forgot-password</span>
                                </div>
                                <div class="endpoint-desc">Request password reset link</div>
                                <div class="endpoint-body">
                                    <div id="forgot-password-form">
                                        <div class="input-group">
                                            <label>Email</label>
                                            <input id="forgot-email" type="email" placeholder="john@example.com" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('POST', '/api/auth/forgot-password', 'forgot-password-form', 'forgot-password-response')">Test Endpoint</button>
                                    <div class="response" id="forgot-password-response"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users APIs (accordion) -->
                <div class="accordion" id="accordion-users">
                    <div class="accordion-toggle collapsed" data-target="users-content" role="button" aria-expanded="false" tabindex="0">
                        <div class="title"><span>üë•</span><span>Users</span></div>
                        <div class="icon">‚ñæ</div>
                    </div>
                    <div id="users-content" class="accordion-content" aria-hidden="true">
                        <div class="api-section">
                            <h2 class="section-title">üë• Users</h2>
                            
                            <!-- Token input for user-management endpoints -->
                            <div class="input-group">
                                <label>Auth Token (JWT)</label>
                                <input id="users-token" type="text" placeholder="Paste token here for protected endpoints" />
                                <div style="margin-top:8px;font-size:13px;color:#555;">
                                    Role: <strong id="token-role-label">unknown</strong>
                                    <button id="apply-token-btn" class="btn-test" style="margin-left:10px;padding:6px 10px;font-size:0.9em;">Apply token</button>
                                </div>
                            </div>
                            
                            <!-- List all users (admin-only) - New endpoint -->
                            <div class="endpoint admin-only">
                                <div class="endpoint-header">
                                    <span class="method get">GET</span>
                                    <span class="endpoint-path">/api/users</span>
                                </div>
                                <div class="endpoint-desc">List all users (Admin only - Requires user_management permission)</div>
                                <div class="endpoint-body">
                                    <button class="btn-test" onclick="testEndpoint('GET', '/api/users', null, 'users-list-all-response')">Test Endpoint</button>
                                    <div class="response" id="users-list-all-response"></div>
                                </div>
                            </div>
                            
                            <!-- Get user by ID -->
                            <div class="endpoint">
                                <div class="endpoint-header">
                                    <span class="method get">GET</span>
                                    <span class="endpoint-path">/api/users/:id</span>
                                </div>
                                <div class="endpoint-desc">Get user by ID (You can view your own profile, or admin can view any user)</div>
                                <div class="endpoint-body">
                                    <div id="get-user-by-id-form">
                                        <div class="input-group">
                                            <label>User ID</label>
                                            <input id="get-user-id" type="text" placeholder="Enter user id" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('GET', '/api/users/:id', 'get-user-by-id-form', 'users-get-by-id-response')">Test Endpoint</button>
                                    <div class="response" id="users-get-by-id-response"></div>
                                </div>
                            </div>
                            
                            <!-- List all users (admin-only) - Old endpoint -->
                            <div class="endpoint admin-only">
                                <div class="endpoint-header">
                                    <span class="method get">GET</span>
                                    <span class="endpoint-path">/api/auth/users</span>
                                </div>
                                <div class="endpoint-desc">List all users (requires token) - Legacy endpoint</div>
                                <div class="endpoint-body">
                                    <button class="btn-test" onclick="testEndpoint('GET', '/api/auth/users', 'users-token', 'users-list-response')">Test Endpoint</button>
                                    <div class="response" id="users-list-response"></div>
                                </div>
                            </div>
                            
                            <!-- Delete user (admin-only) -->
                            <div class="endpoint admin-only">
                                <div class="endpoint-header">
                                    <span class="method delete">DELETE</span>
                                    <span class="endpoint-path">/api/auth/users/:id</span>
                                </div>
                                <div class="endpoint-desc">Delete user by ID (requires token)</div>
                                <div class="endpoint-body">
                                    <div id="delete-user-form">
                                        <div class="input-group">
                                            <label>User ID to Delete</label>
                                            <input id="delete-user-id" type="text" placeholder="Enter user id" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('DELETE', '/api/auth/users/:id', 'delete-user-form', 'users-delete-response')">Test Endpoint</button>
                                    <div class="response" id="users-delete-response"></div>
                                </div>
                            </div>
                            
                            <!-- Update user (admin-only) -->
                            <div class="endpoint admin-only">
                                <div class="endpoint-header">
                                    <span class="method put">PUT</span>
                                    <span class="endpoint-path">/api/auth/users/:id</span>
                                </div>
                                <div class="endpoint-desc">Update user by ID (provide any fields to update; requires token)</div>
                                <div class="endpoint-body">
                                    <div id="update-user-form">
                                        <div class="input-group">
                                            <label>User ID to Update</label>
                                            <input id="update-user-id" type="text" placeholder="Enter user id" />
                                        </div>
                                        <div class="input-group">
                                            <label>Name</label>
                                            <input id="update-name" type="text" placeholder="New name (optional)" />
                                        </div>
                                        <div class="input-group">
                                            <label>Email</label>
                                            <input id="update-email" type="email" placeholder="New email (optional)" />
                                        </div>
                                        <div class="input-group">
                                            <label>Mobile</label>
                                            <input id="update-mobile" type="text" placeholder="New mobile (optional)" />
                                        </div>
                                        <div class="input-group">
                                            <label>New Password</label>
                                            <input id="update-password" type="password" placeholder="New password (optional)" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('PUT', '/api/auth/users/:id', 'update-user-form', 'users-update-response')">Test Endpoint</button>
                                    <div class="response" id="users-update-response"></div>
                                </div>
                            </div>
                            
                            <div class="endpoint">
                                <div class="endpoint-header">
                                    <span class="method get">GET</span>
                                    <span class="endpoint-path">/api/users/me</span>
                                </div>
                                <div class="endpoint-desc">Get current user profile (requires authentication)</div>
                                <div class="endpoint-body">
                                    <div style="padding: 10px; background: #fff3cd; border-radius: 4px; margin-bottom: 10px; font-size: 0.9em;">
                                        ‚ö†Ô∏è Requires Authorization header: Bearer token
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('GET', '/api/users/me', null, 'users-me-response')">Test Endpoint</button>
                                    <div class="response" id="users-me-response"></div>
                                </div>
                            </div>
                            
                            <div class="endpoint">
                                <div class="endpoint-header">
                                    <span class="method put">PUT</span>
                                    <span class="endpoint-path">/api/users/me</span>
                                </div>
                                <div class="endpoint-desc">Update current user profile (requires authentication)</div>
                                <div class="endpoint-body">
                                    <div id="update-me-form">
                                        <div class="input-group">
                                            <label>Name</label>
                                            <input id="update-me-name" type="text" placeholder="New name (optional)" />
                                        </div>
                                        <div class="input-group">
                                            <label>Phone</label>
                                            <input id="update-me-phone" type="text" placeholder="New phone (optional)" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('PUT', '/api/users/me', 'update-me-form', 'users-update-me-response')">Test Endpoint</button>
                                    <div class="response" id="users-update-me-response"></div>
                                </div>
                            </div>
                            
                            <!-- Update user role (admin-only) -->
                            <div class="endpoint admin-only">
                                <div class="endpoint-header">
                                    <span class="method put">PUT</span>
                                    <span class="endpoint-path">/api/users/:id/role</span>
                                </div>
                                <div class="endpoint-desc">Update user role (Admin only) - Set role to 0 (admin) or 1 (volunteer)</div>
                                <div class="endpoint-body">
                                    <div id="update-user-role-form">
                                        <div class="input-group">
                                            <label>User ID</label>
                                            <input id="update-role-user-id" type="text" placeholder="Enter user id" />
                                        </div>
                                        <div class="input-group">
                                            <label>Role</label>
                                            <select id="update-role-value" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="0">Admin (0)</option>
                                                <option value="1">Volunteer (1)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('PUT', '/api/users/:id/role', 'update-user-role-form', 'users-update-role-response')">Test Endpoint</button>
                                    <div class="response" id="users-update-role-response"></div>
                                </div>
                            </div>
                            
                            <!-- Update user details (admin-only) -->
                            <div class="endpoint admin-only">
                                <div class="endpoint-header">
                                    <span class="method put">PUT</span>
                                    <span class="endpoint-path">/api/users/:id</span>
                                </div>
                                <div class="endpoint-desc">Update user details (Admin only) - Update name, email, phone</div>
                                <div class="endpoint-body">
                                    <div id="update-user-details-form">
                                        <div class="input-group">
                                            <label>User ID to Update</label>
                                            <input id="update-details-user-id" type="text" placeholder="Enter user id" />
                                        </div>
                                        <div class="input-group">
                                            <label>Name</label>
                                            <input id="update-details-name" type="text" placeholder="New name (optional)" />
                                        </div>
                                        <div class="input-group">
                                            <label>Email</label>
                                            <input id="update-details-email" type="email" placeholder="New email (optional)" />
                                        </div>
                                        <div class="input-group">
                                            <label>Phone</label>
                                            <input id="update-details-phone" type="text" placeholder="New phone (optional)" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('PUT', '/api/users/:id', 'update-user-details-form', 'users-update-details-response')">Test Endpoint</button>
                                    <div class="response" id="users-update-details-response"></div>
                                </div>
                            </div>
                            
                            <!-- Toggle user status (admin-only) -->
                            <div class="endpoint admin-only">
                                <div class="endpoint-header">
                                    <span class="method put">PUT</span>
                                    <span class="endpoint-path">/api/users/:id/status</span>
                                </div>
                                <div class="endpoint-desc">Toggle user active/inactive status (Admin only)</div>
                                <div class="endpoint-body">
                                    <div id="update-user-status-form">
                                        <div class="input-group">
                                            <label>User ID</label>
                                            <input id="update-status-user-id" type="text" placeholder="Enter user id" />
                                        </div>
                                        <div class="input-group">
                                            <label>Is Active</label>
                                            <select id="update-status-is-active" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                                <option value="true">Active (true)</option>
                                                <option value="false">Inactive (false)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('PUT', '/api/users/:id/status', 'update-user-status-form', 'users-update-status-response')">Test Endpoint</button>
                                    <div class="response" id="users-update-status-response"></div>
                                </div>
                            </div>
                            
                            <!-- Delete user (admin-only) - New endpoint -->
                            <div class="endpoint admin-only">
                                <div class="endpoint-header">
                                    <span class="method delete">DELETE</span>
                                    <span class="endpoint-path">/api/users/:id</span>
                                </div>
                                <div class="endpoint-desc">Delete user (Admin only) - Cannot delete own account</div>
                                <div class="endpoint-body">
                                    <div id="delete-user-new-form">
                                        <div class="input-group">
                                            <label>User ID to Delete</label>
                                            <input id="delete-user-new-id" type="text" placeholder="Enter user id" />
                                        </div>
                                    </div>
                                    <button class="btn-test" onclick="testEndpoint('DELETE', '/api/users/:id', 'delete-user-new-form', 'users-delete-new-response')">Test Endpoint</button>
                                    <div class="response" id="users-delete-new-response"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Users Sidebar panel (added) -->
        <aside id="usersSidebar" class="users-sidebar" aria-hidden="true">
            <div class="header">
                <h3>All Users</h3>
                <div>
                    <button id="refreshUsersBtn" class="refresh-btn" title="Refresh">Refresh</button>
                    <button id="closeUsersSidebar" class="close-btn" title="Close">‚úï</button>
                </div>
            </div>

            <div id="usersSidebarContent">
                <div style="margin-bottom:8px;">
                    <label style="font-weight:700;font-size:13px;">Auth Token</label>
                    <div style="display:flex;gap:8px;margin-top:6px;">
                        <input id="sidebar-token" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:monospace" placeholder="Paste token or use 'Auth Token (JWT)' field" />
                        <button id="useDocToken" class="close-btn" title="Copy from docs token input">Use docs token</button>
                    </div>
                </div>

                <div id="usersLoading" class="small">Click Refresh to load users.</div>
                <div id="usersError" class="small" style="color:#c62828;display:none;"></div>

                <div id="usersTableWrap" style="margin-top:12px; display:none;">
                    <table class="users-table" id="usersTable">
                        <thead>
                            <tr><th>ID</th><th>Name</th><th>Email</th><th>Mobile</th><th>Role</th><th>Active</th></tr>
                        </thead>
                        <tbody id="usersTbody"></tbody>
                    </table>
                </div>

                <div id="usersEmpty" class="empty" style="display:none;">No users found or you lack permission (admin only).</div>
            </div>
        </aside>

        <div id="toast" role="status" aria-live="polite"></div>
    </div>
    
    <script>
        const API_BASE_URL = window.location.origin;
        
        // Check server and database status on load
        window.addEventListener('DOMContentLoaded', () => {
            checkServerStatus();
            checkDatabaseStatus();
            populateTokenFromStorage(); // populate token input if stored
        });
        
        // Populate users-token input from localStorage (if present)
        function populateTokenFromStorage() {
            try {
                const t = localStorage.getItem('voluntree_token');
                if (t) {
                    const el = document.getElementById('users-token');
                    if (el) el.value = t;
                }
            } catch (e) { /* ignore */ }
        }

        // Logout handler: clear localStorage token and clear token inputs
        function handleLogout() {
            try {
                localStorage.removeItem('voluntree_token');
            } catch (e) {}
            const tokenInputs = document.querySelectorAll('#users-token');
            tokenInputs.forEach(i => i.value = '');
            showToast('Logged out ‚Äî token cleared');
        }

        function showToast(msg, ms = 2500) {
            const t = document.getElementById('toast');
            if (!t) return;
            t.textContent = msg;
            t.style.display = 'block';
            clearTimeout(t.__hideTimeout);
            t.__hideTimeout = setTimeout(()=> t.style.display = 'none', ms);
        }
        
        async function checkServerStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/');
                const data = await response.json();
                document.getElementById('server-status').textContent = '‚úÖ Server: Running';
                document.getElementById('server-status').parentElement.style.background = '#e8f5e9';
                document.getElementById('server-status').parentElement.style.color = '#2e7d32';
            } catch (error) {
                document.getElementById('server-status').textContent = '‚ùå Server: Offline';
                document.getElementById('server-status').parentElement.style.background = '#ffebee';
                document.getElementById('server-status').parentElement.style.color = '#c62828';
            }
        }
        
        async function checkDatabaseStatus() {
            try {
                const response = await fetch(API_BASE_URL + '/api/health/db');
                const data = await response.json();
                if (data.status === 'connected') {
                    document.getElementById('db-status').textContent = '‚úÖ Database: Connected';
                    document.getElementById('db-status').parentElement.style.background = '#e8f5e9';
                    document.getElementById('db-status').parentElement.style.color = '#2e7d32';
                } else {
                    throw new Error('Database not connected');
                }
            } catch (error) {
                document.getElementById('db-status').textContent = '‚ùå Database: Not Connected';
                document.getElementById('db-status').parentElement.style.background = '#ffebee';
                document.getElementById('db-status').parentElement.style.color = '#c62828';
            }
        }
        
        async function testEndpoint(method, path, bodyElementId = null, responseElementId = null) {
            const responseDiv = document.getElementById(responseElementId || path.replace(/\//g, '-').replace(/:/g, '') + '-response');
            const button = event.target;
            const originalText = button.textContent;
            
            button.disabled = true;
            button.innerHTML = originalText + ' <span class="loading"></span>';
            responseDiv.classList.remove('show');
            
            try {
                let url = API_BASE_URL + path;
                const options = { method };
                
                // prepare headers container
                options.headers = options.headers || {};

                // if a token is present in the users-token input, set Authorization header for protected endpoints
                const globalTokenInput = document.getElementById('users-token');
                const globalToken = globalTokenInput ? globalTokenInput.value.trim() : '';
                if (globalToken) {
                    options.headers['Authorization'] = 'Bearer ' + globalToken;
                }

                // If this is the register form, collect parameters and send them as query params
                if (bodyElementId === 'auth-register-form') {
                    const params = new URLSearchParams();
                    const name = document.getElementById('reg-name').value.trim();
                    const email = document.getElementById('reg-email').value.trim();
                    const mobile = document.getElementById('reg-mobile').value.trim();
                    const password = document.getElementById('reg-password').value;
                    const confirmPassword = document.getElementById('reg-confirmPassword').value;

                    // Build query string (backend reads req.query)
                    if (name) params.append('name', name);
                    if (email) params.append('email', email);
                    if (mobile) params.append('mobile', mobile);
                    if (password) params.append('password', password);
                    if (confirmPassword) params.append('confirmPassword', confirmPassword);

                    if (params.toString()) {
                        url += '?' + params.toString();
                    }
                    // no body required; backend expects params in req.query
                // If this is the login form, collect email/password and send as query params
                } else if (bodyElementId === 'auth-login-form') {
                    const params = new URLSearchParams();
                    const email = document.getElementById('login-email').value.trim();
                    const password = document.getElementById('login-password').value;
                    if (email) params.append('email', email);
                    if (password) params.append('password', password);
                    if (params.toString()) url += '?' + params.toString();
                    // no body; backend reads req.query
                // If this is the forgot-password form, send email as query param
                } else if (bodyElementId === 'forgot-password-form') {
                    const params = new URLSearchParams();
                    const email = document.getElementById('forgot-email').value.trim();
                    if (email) params.append('email', email);
                    if (params.toString()) url += '?' + params.toString();
                    // no body; backend reads req.query
                // If this is the users-token direct button (used for list users), we already set Authorization header above
                } else if (bodyElementId === 'users-token') {
                    // nothing else to do, Authorization header is already set if token provided
                } else if (bodyElementId === 'delete-user-form') {
                    const id = document.getElementById('delete-user-id').value.trim();
                    if (!id) throw new Error('Please provide user id to delete');
                    url = API_BASE_URL + path.replace(':id', encodeURIComponent(id));
                    // Authorization header set above if token provided; fallback to query param if not
                    if (!options.headers['Authorization']) {
                        const token = document.getElementById('users-token').value.trim();
                        if (token) url += '?token=' + encodeURIComponent(token);
                    }
                } else if (bodyElementId === 'update-user-form') {
                    const id = document.getElementById('update-user-id').value.trim();
                    if (!id) throw new Error('Please provide user id to update');
                    url = API_BASE_URL + path.replace(':id', encodeURIComponent(id));
                    const params = new URLSearchParams();
                    const name = document.getElementById('update-name').value.trim();
                    const email = document.getElementById('update-email').value.trim();
                    const mobile = document.getElementById('update-mobile').value.trim();
                    const password = document.getElementById('update-password').value;
                    if (name) params.append('name', name);
                    if (email) params.append('email', email);
                    if (mobile) params.append('mobile', mobile);
                    if (password) params.append('password', password);
                    // Authorization header already set above; fallback to token query param if missing
                    if (params.toString()) {
                        if (options.headers['Authorization']) {
                            url += '?' + params.toString();
                        } else {
                            // append token too if present
                            const token = document.getElementById('users-token').value.trim();
                            if (token) params.append('token', token);
                            url += '?' + params.toString();
                        }
                    } else if (!options.headers['Authorization']) {
                        const token = document.getElementById('users-token').value.trim();
                        if (token) url += '?token=' + encodeURIComponent(token);
                    }
                } else if (bodyElementId === 'get-user-by-id-form') {
                    const id = document.getElementById('get-user-id').value.trim();
                    if (!id) throw new Error('Please provide user id');
                    url = API_BASE_URL + path.replace(':id', encodeURIComponent(id));
                    // Authorization header set above if token provided
                } else if (bodyElementId === 'update-user-role-form') {
                    const id = document.getElementById('update-role-user-id').value.trim();
                    if (!id) throw new Error('Please provide user id');
                    url = API_BASE_URL + path.replace(':id', encodeURIComponent(id));
                    const roleValue = document.getElementById('update-role-value').value;
                    const bodyData = { role: parseInt(roleValue) };
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(bodyData);
                } else if (bodyElementId === 'update-user-details-form') {
                    const id = document.getElementById('update-details-user-id').value.trim();
                    if (!id) throw new Error('Please provide user id to update');
                    url = API_BASE_URL + path.replace(':id', encodeURIComponent(id));
                    const bodyData = {};
                    const name = document.getElementById('update-details-name').value.trim();
                    const email = document.getElementById('update-details-email').value.trim();
                    const phone = document.getElementById('update-details-phone').value.trim();
                    if (name) bodyData.name = name;
                    if (email) bodyData.email = email;
                    if (phone) bodyData.phone = phone;
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(bodyData);
                } else if (bodyElementId === 'update-user-status-form') {
                    const id = document.getElementById('update-status-user-id').value.trim();
                    if (!id) throw new Error('Please provide user id');
                    url = API_BASE_URL + path.replace(':id', encodeURIComponent(id));
                    const isActiveValue = document.getElementById('update-status-is-active').value;
                    const bodyData = { is_active: isActiveValue === 'true' };
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(bodyData);
                } else if (bodyElementId === 'delete-user-new-form') {
                    const id = document.getElementById('delete-user-new-id').value.trim();
                    if (!id) throw new Error('Please provide user id to delete');
                    url = API_BASE_URL + path.replace(':id', encodeURIComponent(id));
                    // Authorization header set above if token provided
                } else if (bodyElementId === 'update-me-form') {
                    const bodyData = {};
                    const name = document.getElementById('update-me-name').value.trim();
                    const phone = document.getElementById('update-me-phone').value.trim();
                    if (name) bodyData.name = name;
                    if (phone) bodyData.phone = phone;
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(bodyData);
                } else if (bodyElementId) {
                    // existing behavior for JSON body textareas (for backward compatibility)
                    const bodyElement = document.getElementById(bodyElementId);
                    if (bodyElement && bodyElement.tagName === 'TEXTAREA') {
                        const bodyText = bodyElement.value.trim();
                        if (bodyText) {
                            try {
                                options.headers = options.headers || {};
                                options.headers['Content-Type'] = 'application/json';
                                options.body = JSON.stringify(JSON.parse(bodyText));
                            } catch (e) {
                                throw new Error('Invalid JSON format');
                            }
                        }
                    }
                }

                const response = await fetch(url, options);
                const data = await response.json();
                
                const statusClass = response.ok ? 'success' : 'error';
                responseDiv.innerHTML = `
                    <div class="response-header">
                        <span class="status-code ${statusClass}">Status: ${response.status}</span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="response-body">${JSON.stringify(data, null, 2)}</div>
                `;
                responseDiv.classList.add('show');
            } catch (error) {
                responseDiv.innerHTML = `
                    <div class="response-header">
                        <span class="status-code error">Error</span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="response-body">${error.message}</div>
                `;
                responseDiv.classList.add('show');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        async function testAllEndpoints() {
            const endpoints = [
                { method: 'GET', path: '/api/users' },
                { method: 'GET', path: '/api/volunteers' },
                { method: 'GET', path: '/api/organizations' },
            ];
            
            for (const endpoint of endpoints) {
                await new Promise(resolve => setTimeout(resolve, 500));
                const button = Array.from(document.querySelectorAll('.btn-test')).find(btn => 
                    btn.getAttribute('onclick')?.includes(endpoint.path)
                );
                if (button) {
                    button.click();
                }
            }
        }
        
        // Accordion toggle logic (added)
        (function initAccordions(){
            function togglePanel(toggleEl) {
                const targetId = toggleEl.getAttribute('data-target');
                const panel = document.getElementById(targetId);
                const expanded = toggleEl.classList.contains('collapsed') === false;
                if (expanded) {
                    // collapse
                    toggleEl.classList.add('collapsed');
                    toggleEl.setAttribute('aria-expanded', 'false');
                    if (panel) { panel.classList.remove('show'); panel.setAttribute('aria-hidden', 'true'); }
                } else {
                    // expand
                    toggleEl.classList.remove('collapsed');
                    toggleEl.setAttribute('aria-expanded', 'true');
                    if (panel) { panel.classList.add('show'); panel.setAttribute('aria-hidden', 'false'); }
                }
            }

            document.querySelectorAll('.accordion-toggle').forEach(toggle => {
                // default collapsed (already set). Add click and keyboard support.
                toggle.addEventListener('click', () => togglePanel(toggle));
                toggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        togglePanel(toggle);
                    }
                });
            });
        })();

        // Helper: decode JWT payload (no verification) safely
        function parseJwtPayload(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) return null;
                const payload = parts[1].replace(/-/g, '+').replace(/_/g, '/');
                const json = decodeURIComponent(atob(payload).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(json);
            } catch (e) {
                return null;
            }
        }

        // Toggle admin-only elements based on token role (0 = admin)
        function updateAdminVisibility() {
            const tokenInput = document.getElementById('users-token');
            const roleLabel = document.getElementById('token-role-label');
            const token = (tokenInput && tokenInput.value.trim()) || localStorage.getItem('voluntree_token') || '';
            let payload = null;
            if (token) payload = parseJwtPayload(token);
            const isAdmin = payload && (Number(payload.role) === 0);
            roleLabel.textContent = payload ? (Number(payload.role) === 0 ? 'admin (0)' : 'volunteer (1)') : (token ? 'invalid token' : 'none');

            // show/hide admin-only endpoints
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = isAdmin ? '' : 'none';
            });

            // auto-expand users accordion if admin and collapsed
            const usersToggle = document.querySelector('#accordion-users .accordion-toggle');
            const usersContent = document.getElementById('users-content');
            if (isAdmin && usersToggle && usersContent && usersToggle.classList.contains('collapsed')) {
                usersToggle.classList.remove('collapsed');
                usersToggle.setAttribute('aria-expanded', 'true');
                usersContent.classList.add('show');
                usersContent.setAttribute('aria-hidden', 'false');
            }
            // If not admin, collapse users accordion to reduce clutter
            if (!isAdmin && usersToggle && usersContent && !usersToggle.classList.contains('collapsed')) {
                usersToggle.classList.add('collapsed');
                usersToggle.setAttribute('aria-expanded', 'false');
                usersContent.classList.remove('show');
                usersContent.setAttribute('aria-hidden', 'true');
            }
        }

        // Wire token apply button and input changes
        document.addEventListener('DOMContentLoaded', () => {
            // run existing init code...
            try { updateAdminVisibility(); } catch(e) {}
            const tokenInput = document.getElementById('users-token');
            if (tokenInput) {
                tokenInput.addEventListener('input', () => updateAdminVisibility());
            }
            const applyBtn = document.getElementById('apply-token-btn');
            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    const t = document.getElementById('users-token').value.trim();
                    if (t) localStorage.setItem('voluntree_token', t);
                    updateAdminVisibility();
                });
            }
        });

        // Users sidebar logic (added)
        (function(){
            const sidebar = document.getElementById('usersSidebar');
            const openBtn = document.getElementById('openUsersSidebar');
            const closeBtn = document.getElementById('closeUsersSidebar');
            const refreshBtn = document.getElementById('refreshUsersBtn');
            const usersLoading = document.getElementById('usersLoading');
            const usersError = document.getElementById('usersError');
            const usersTableWrap = document.getElementById('usersTableWrap');
            const usersTbody = document.getElementById('usersTbody');
            const usersEmpty = document.getElementById('usersEmpty');
            const sidebarTokenInput = document.getElementById('sidebar-token');
            const useDocTokenBtn = document.getElementById('useDocToken');

            function openSidebar(){
                sidebar.classList.add('open');
                sidebar.setAttribute('aria-hidden','false');
                // auto-copy token from docs input if empty
                if (!sidebarTokenInput.value) {
                    const docTokenInput = document.getElementById('users-token');
                    if (docTokenInput && docTokenInput.value) sidebarTokenInput.value = docTokenInput.value;
                    else {
                        const saved = localStorage.getItem('voluntree_token');
                        if (saved) sidebarTokenInput.value = saved;
                    }
                }
                // load users on open
                fetchUsers();
            }
            function closeSidebar(){
                sidebar.classList.remove('open');
                sidebar.setAttribute('aria-hidden','true');
            }
            openBtn.addEventListener('click', () => {
                if (sidebar.classList.contains('open')) closeSidebar(); else openSidebar();
            });
            closeBtn.addEventListener('click', closeSidebar);
            refreshBtn.addEventListener('click', fetchUsers);
            useDocTokenBtn.addEventListener('click', () => {
                const docToken = (document.getElementById('users-token') || {}).value || localStorage.getItem('voluntree_token') || '';
                if (docToken) sidebarTokenInput.value = docToken;
            });

            async function fetchUsers(){
                usersError.style.display = 'none';
                usersTableWrap.style.display = 'none';
                usersEmpty.style.display = 'none';
                usersLoading.style.display = 'block';
                usersLoading.textContent = 'Loading users...';

                const token = sidebarTokenInput.value.trim();
                if (!token) {
                    usersLoading.style.display = 'none';
                    usersError.style.display = 'block';
                    usersError.textContent = 'Token missing. Paste admin token above.';
                    return;
                }

                try {
                    const res = await fetch('/api/auth/users', {
                        method: 'GET',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    const data = await res.json();
                    if (!res.ok) {
                        const msg = data && data.message ? data.message : res.statusText;
                        usersLoading.style.display = 'none';
                        usersError.style.display = 'block';
                        usersError.textContent = `Error: ${msg}`;
                        return;
                    }
                    const users = (data && data.data) || [];
                    usersTbody.innerHTML = '';
                    if (!users || users.length === 0) {
                        usersLoading.style.display = 'none';
                        usersEmpty.style.display = 'block';
                        return;
                    }
                    for (const u of users) {
                        const tr = document.createElement('tr');
                        const roleLabel = (v) => (Number(v) === 0 ? 'admin' : 'volunteer');
                        tr.innerHTML = `<td>${u.id}</td><td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td><td>${escapeHtml(u.mobile || u.phone || '')}</td><td>${roleLabel(u.role)}</td><td>${u.is_active == 1 ? 'Yes' : 'No'}</td>`;
                        usersTbody.appendChild(tr);
                    }
                    usersLoading.style.display = 'none';
                    usersTableWrap.style.display = 'block';
                } catch (err) {
                    usersLoading.style.display = 'none';
                    usersError.style.display = 'block';
                    usersError.textContent = 'Network error';
                }
            }

            function escapeHtml(s) {
                if (s === null || s === undefined) return '';
                return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
            }
        })();
    </script>
</body>
</html>

